---
interface Props {
  wordSlug: string;
  wordEmoji: string;
}

const { wordSlug, wordEmoji } = Astro.props;
---

<div class="bergamo-map-wrapper">
  <!-- Loading State -->
  <div id="map-loading" class="flex flex-col items-center justify-center py-20 bg-gradient-to-br from-amber-50 to-green-50 rounded-2xl">
    <div class="relative">
      <div class="w-20 h-20 border-4 border-amber-200 rounded-full animate-spin border-t-amber-500"></div>
      <div class="absolute inset-0 flex items-center justify-center">
        <span class="text-3xl">{wordEmoji}</span>
      </div>
    </div>
    <p class="mt-4 text-gray-500 font-medium">Caricamento mappa...</p>
  </div>

  <!-- Map Container -->
  <div id="map-container" class="hidden">
    <div id="bergamo-map" class="w-full h-[500px] md:h-[600px] rounded-2xl overflow-hidden shadow-inner"></div>
  </div>

  <!-- Legend -->
  <div id="map-legend" class="hidden mt-6">
    <div class="bg-white rounded-2xl shadow-lg p-4">
      <h3 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
        <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
        </svg>
        Varianti dialettali
      </h3>
      <div id="legend-items" class="flex flex-wrap gap-2"></div>
    </div>
  </div>

  <!-- Stats -->
  <div id="map-stats" class="hidden mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
  </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script define:vars={{ wordSlug }}>
  // Load Leaflet dynamically
  const script = document.createElement('script');
  script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
  script.onload = initMap;
  document.head.appendChild(script);

  async function initMap() {
    const loading = document.getElementById('map-loading');
    const mapContainer = document.getElementById('map-container');
    const legendDiv = document.getElementById('map-legend');
    const legendItems = document.getElementById('legend-items');
    const statsDiv = document.getElementById('map-stats');

    try {
      // Load data
      const [geoData, wordData] = await Promise.all([
        fetch('/data/bergamo.geojson').then(r => r.json()),
        fetch(`/data/words/${wordSlug}.json`).then(r => r.json())
      ]);

      // Hide loading, show map
      loading.classList.add('hidden');
      mapContainer.classList.remove('hidden');
      legendDiv.classList.remove('hidden');
      statsDiv.classList.remove('hidden');

      // Color palette - vivid and distinct
      const colors = [
        '#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6',
        '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef',
        '#ec4899', '#f43f5e', '#84cc16', '#10b981', '#0ea5e9',
        '#a855f7', '#f59e0b', '#64748b', '#78716c', '#71717a'
      ];

      // Count variants and assign colors
      const variantCounts = {};
      const variantColors = {};
      let colorIndex = 0;

      Object.values(wordData.municipalities).forEach(v => {
        variantCounts[v] = (variantCounts[v] || 0) + 1;
        if (!variantColors[v] && v !== 'Nessun Dato') {
          variantColors[v] = colors[colorIndex % colors.length];
          colorIndex++;
        }
      });
      variantColors['Nessun Dato'] = '#d1d5db';

      // Sort variants by count
      const sortedVariants = Object.entries(variantCounts)
        .sort((a, b) => b[1] - a[1]);

      // Initialize map centered on Bergamo province
      const map = L.map('bergamo-map', {
        zoomControl: true,
        scrollWheelZoom: true
      }).setView([45.75, 9.85], 10);

      // Add tile layer (subtle gray style)
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap, &copy; CARTO',
        maxZoom: 19
      }).addTo(map);

      // Style function for features
      function getStyle(feature) {
        const variant = wordData.municipalities[feature.properties.name] || 'Nessun Dato';
        return {
          fillColor: variantColors[variant] || '#d1d5db',
          weight: 1,
          opacity: 1,
          color: '#ffffff',
          fillOpacity: 0.75
        };
      }

      // Highlight style
      function highlightStyle(feature) {
        const variant = wordData.municipalities[feature.properties.name] || 'Nessun Dato';
        return {
          fillColor: variantColors[variant] || '#d1d5db',
          weight: 3,
          opacity: 1,
          color: '#1f2937',
          fillOpacity: 0.9
        };
      }

      // Add GeoJSON layer
      let activeVariant = null;
      const geoLayer = L.geoJSON(geoData, {
        style: getStyle,
        onEachFeature: function(feature, layer) {
          const name = feature.properties.name;
          const variant = wordData.municipalities[name] || 'Nessun Dato';

          // Tooltip
          layer.bindTooltip(`
            <div class="font-sans">
              <strong class="text-base">${name}</strong><br>
              <span class="text-amber-600 font-medium">${variant === 'Nessun Dato' ? 'Nessun dato' : '"' + variant + '"'}</span>
            </div>
          `, {
            sticky: true,
            className: 'custom-tooltip'
          });

          // Popup on click
          layer.bindPopup(`
            <div class="font-sans text-center p-2">
              <h3 class="font-bold text-lg mb-1">${name}</h3>
              <p class="text-xl" style="color: ${variantColors[variant]}">${variant === 'Nessun Dato' ? 'Nessun dato disponibile' : variant}</p>
            </div>
          `);

          // Hover effects
          layer.on({
            mouseover: function(e) {
              if (!activeVariant || activeVariant === variant) {
                layer.setStyle(highlightStyle(feature));
                layer.bringToFront();
              }
            },
            mouseout: function(e) {
              geoLayer.resetStyle(layer);
              if (activeVariant && activeVariant !== variant) {
                layer.setStyle({ fillOpacity: 0.2 });
              }
            }
          });
        }
      }).addTo(map);

      // Fit map to bounds
      map.fitBounds(geoLayer.getBounds(), { padding: [20, 20] });

      // Create legend
      legendItems.innerHTML = sortedVariants.map(([variant, count]) => `
        <button
          class="legend-btn flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105 border-2"
          style="background-color: ${variantColors[variant]}15; border-color: ${variantColors[variant]}"
          data-variant="${variant}"
        >
          <span class="w-4 h-4 rounded-full flex-shrink-0" style="background-color: ${variantColors[variant]}"></span>
          <span class="text-gray-700 truncate max-w-[150px]">${variant}</span>
          <span class="text-gray-400 text-xs flex-shrink-0">${count}</span>
        </button>
      `).join('');

      // Legend click handlers
      document.querySelectorAll('.legend-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const variant = this.dataset.variant;

          // Toggle active state
          if (activeVariant === variant) {
            activeVariant = null;
            document.querySelectorAll('.legend-btn').forEach(b => {
              b.classList.remove('ring-2', 'ring-amber-500', 'ring-offset-2');
            });
            geoLayer.eachLayer(layer => {
              geoLayer.resetStyle(layer);
            });
          } else {
            activeVariant = variant;
            document.querySelectorAll('.legend-btn').forEach(b => {
              b.classList.remove('ring-2', 'ring-amber-500', 'ring-offset-2');
            });
            this.classList.add('ring-2', 'ring-amber-500', 'ring-offset-2');

            geoLayer.eachLayer(layer => {
              const v = wordData.municipalities[layer.feature.properties.name] || 'Nessun Dato';
              if (v === variant) {
                layer.setStyle({ fillOpacity: 0.9, weight: 2 });
                layer.bringToFront();
              } else {
                layer.setStyle({ fillOpacity: 0.15, weight: 0.5 });
              }
            });
          }
        });
      });

      // Stats
      const uniqueVariants = Object.keys(variantCounts).filter(v => v !== 'Nessun Dato').length;
      const topVariant = sortedVariants.find(([v]) => v !== 'Nessun Dato');
      const coverage = Math.round((1 - (variantCounts['Nessun Dato'] || 0) / 243) * 100);

      statsDiv.innerHTML = `
        <div class="bg-white rounded-xl p-4 shadow text-center">
          <div class="text-2xl font-bold text-amber-500">${uniqueVariants}</div>
          <div class="text-xs text-gray-500">Varianti</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow text-center">
          <div class="text-2xl font-bold text-green-500">${coverage}%</div>
          <div class="text-xs text-gray-500">Copertura</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow text-center">
          <div class="text-2xl font-bold text-blue-500">${topVariant ? topVariant[1] : 0}</div>
          <div class="text-xs text-gray-500">Comuni top</div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow text-center">
          <div class="text-2xl font-bold text-purple-500">243</div>
          <div class="text-xs text-gray-500">Totale comuni</div>
        </div>
      `;

    } catch (error) {
      console.error('Error loading map:', error);
      loading.innerHTML = `
        <div class="text-center py-10">
          <div class="text-6xl mb-4">üó∫Ô∏è</div>
          <p class="text-gray-500 mb-2">Errore nel caricamento della mappa</p>
          <p class="text-sm text-gray-400">${error.message}</p>
        </div>
      `;
    }
  }
</script>

<style is:global>
  .custom-tooltip {
    background: white;
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    padding: 8px 12px;
  }

  .custom-tooltip .leaflet-tooltip-tip {
    display: none;
  }

  .leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  }

  .leaflet-popup-content {
    margin: 8px 12px;
  }

  .leaflet-container {
    font-family: 'Inter', system-ui, sans-serif;
  }
</style>
